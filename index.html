<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Check Kaiwa - Học Viên</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: #f4f6f9; padding: 20px; color: #333; }
    .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h1 { text-align: center; margin-bottom: 20px; color: #2c3e50; }
    .filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
    .filters select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; flex: 1; min-width: 150px; }
    .btn-start {
      padding: 12px 30px; background: #27ae60; color: white; border: none; border-radius: 6px;
      font-size: 16px; cursor: not-allowed; opacity: 0.5; transition: all 0.3s;
    }
    .btn-start.enabled { background: #27ae60; opacity: 1; cursor: pointer; }
    .btn-start.enabled:hover { background: #219653; }
    .lesson-filter { margin: 15px 0; text-align: center; }
    .lesson-filter select {
      padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; width: 200px;
    }
    .loading { text-align: center; padding: 20px; color: #777; }
    .student-list { margin-top: 20px; display: none; }
    .student-card { border: 1px solid #eee; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
    .student-header { background: #3498db; color: white; padding: 12px 16px; font-weight: bold; }
    .question-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .question-table th, .question-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    .question-table th { background: #f8f9fa; }
    .question-id { font-weight: bold; color: #2c3e50; width: 50px; }
    .question-text { flex: 1; }
    .check-col { text-align: center; width: 80px; }
    .check-circle {
      width: 20px; height: 20px; border-radius: 50%; border: 2px solid #ddd;
      display: inline-block; cursor: pointer;
    }
    .check-circle.pass {
      background: #27ae60; border-color: #27ae60;
    }
    .check-circle.fail {
      background: #e74c3c; border-color: #e74c3c;
    }
    .summary { margin: 10px 0; font-weight: bold; color: #27ae60; }
    .fail-summary { color: #e74c3c; }
    .filter-fail { margin: 20px 0; text-align: center; display: block; }
    .filter-fail button { padding: 12px 24px; background: #e67e22; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 0 5px; }
    .filter-fail button:hover { background: #d35400; }
    .fail-list { margin-top: 20px; background: #fdf2e9; padding: 15px; border-radius: 8px; border: 1px solid #f39c12; display: none; }
    .fail-class-group {
      margin-bottom: 25px;
      padding: 18px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid #dee2e6;
    }
    .fail-class-title {
      font-weight: bold;
      font-size: 1.15em;
      color: #2c3e50;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #3498db;
    }
    .fail-item {
      margin: 8px 0;
      padding: 10px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .no-data { text-align: center; color: #95a5a6; padding: 40px; font-size: 18px; }
    #failButton { display: none; }
    #historyButton { display: inline-block; }
    @media (max-width: 768px) {
      .filters { flex-direction: column; }
      .question-table { font-size: 13px; }
      .filter-fail button { width: 100%; margin: 5px 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Check Kaiwa - Học Viên</h1>
    <div class="filters">
      <select id="class" onchange="onFilterChange()">
        <option value="">Chọn Lớp</option>
      </select>
      <select id="personInCharge" onchange="onPersonChange()" disabled>
        <option value="">Chọn Phụ Trách</option>
      </select>
      <select id="union" onchange="onUnionChange()" disabled>
        <option value="">Chọn Nghiệp Đoàn</option>
      </select>
      <select id="company" onchange="onCompanyChange()" disabled>
        <option value="">Chọn Công Ty</option>
      </select>
      <select id="student" onchange="updateStartButton()" disabled>
        <option value="">Chọn Họ và Tên</option>
      </select>
      <button id="btnStart" class="btn-start" disabled onclick="startChecking()">Bắt đầu kiểm tra</button>
    </div>
    <div class="loading" id="loading">Đang tải dữ liệu học viên...</div>
    <div id="studentContainer" class="student-list"></div>
    <div class="lesson-filter" id="lessonFilter" style="display:none;">
      <strong>Lọc theo bài:</strong>
      <select id="lessonSelect" onchange="currentLesson = this.value; renderStudents();">
        <option value="all">Tất cả các bài</option>
      </select>
    </div>
    <div class="filter-fail">
      <button id="historyButton" onclick="showHistory()">Lịch sử kiểm tra</button>
      <button id="failButton" onclick="showFailedQuestions()">Xem các câu Không Đạt</button>
    </div>
    <div id="failList" class="fail-list"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAfy4QMD9_7PyFHpInNdKDRWuW4AYCtLJ4",
      authDomain: "history-e4633.firebaseapp.com",
      projectId: "history-e4633",
      storageBucket: "history-e4633.firebasestorage.app",
      messagingSenderId: "331974436893",
      appId: "1:331974436893:web:10c3c6adf7b66d2b5fbef4",
      measurementId: "G-DC055090BW"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const COLLECTION_NAME = 'testHistorykaiwadinhki';

    let sheetData = [];
    let currentLesson = 'all';
    let isChecking = false;

    const questions = [
      { lesson: 1, id: "1.1", text: "<ruby>名<rt>な</rt></ruby><ruby>前<rt>まえ</rt></ruby>は何ですか。" },
      // Thêm các câu hỏi khác ở đây
    ];

    const lessons = [...new Set(questions.map(q => q.lesson))].sort((a, b) => a - b);

    // Fetch dữ liệu từ SheetDB
    async function fetchSheetData() {
      const loading = document.getElementById('loading');
      loading.style.display = 'block';
      try {
        const response = await fetch('https://sheetdb.io/api/v1/nowbvmpq7ee5q');
        if (!response.ok) throw new Error('Lỗi tải dữ liệu');
        const rawData = await response.json();
        sheetData = rawData
          .filter(item => item['Lớp'] && item['Lớp'].trim())
          .map(item => {
            let hoTen = 'Không rõ';
            const possibleNameKeys = ['Họ Tên', 'Họ và Tên', 'Họ tên', 'Tên', 'Full Name', 'Họ Tên Học Viên', 'Họ Tên HV', 'Name'];
            for (const key of possibleNameKeys) {
              if (item[key] && item[key].trim()) {
                hoTen = item[key].trim();
                break;
              }
            }
            return {
              ...item,
              'Nghiệp Đoàn': (item['Nghiệp Đoàn'] || '').trim().toUpperCase(),
              'Công Ty': (item['Công Ty'] || '').trim().toUpperCase(),
              'Lớp': item['Lớp'].trim().toUpperCase(),
              'Phụ Trách': (item['Phụ Trách'] || '').trim().toUpperCase(),
              'Họ Tên': hoTen
            };
          });
        populateClassDropdown();
        populateLessonFilter();
      } catch (error) {
        console.error('Error:', error);
        loading.innerHTML = 'Không thể tải dữ liệu từ SheetDB. Vui lòng kiểm tra URL hoặc kết nối.';
      } finally {
        loading.style.display = 'none';
      }
    }

    function populateClassDropdown() {
      const classSelect = document.getElementById('class');
      classSelect.innerHTML = '<option value="">Chọn Lớp</option>';
      const unique = [...new Set(sheetData.map(item => item['Lớp']))].sort();
      unique.forEach(cls => {
        const opt = document.createElement('option');
        opt.value = cls; opt.textContent = cls;
        classSelect.appendChild(opt);
      });
    }

    function populateLessonFilter() {
      const select = document.getElementById('lessonSelect');
      select.innerHTML = '<option value="all">Tất cả các bài</option>';
      lessons.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l; opt.textContent = `Bài ${l}`;
        select.appendChild(opt);
      });
    }

    function onFilterChange() {
      const cls = document.getElementById('class').value;
      const personSelect = document.getElementById('personInCharge');
      personSelect.innerHTML = '<option value="">Chọn Phụ Trách</option>'; personSelect.disabled = true;
      document.getElementById('union').innerHTML = '<option value="">Chọn Nghiệp Đoàn</option>'; document.getElementById('union').disabled = true;
      document.getElementById('company').innerHTML = '<option value="">Chọn Công Ty</option>'; document.getElementById('company').disabled = true;
      document.getElementById('student').innerHTML = '<option value="">Chọn Họ và Tên</option>'; document.getElementById('student').disabled = true;
      if (cls) {
        const filtered = sheetData.filter(i => i['Lớp'] === cls);
        const persons = [...new Set(filtered.map(i => i['Phụ Trách']).filter(Boolean))].sort();
        persons.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p; opt.textContent = p;
          personSelect.appendChild(opt);
        });
        personSelect.disabled = false;
      }
      updateStartButton();
    }

    function onPersonChange() {
      const cls = document.getElementById('class').value;
      const person = document.getElementById('personInCharge').value;
      const unionSelect = document.getElementById('union');
      unionSelect.innerHTML = '<option value="">Chọn Nghiệp Đoàn</option>'; unionSelect.disabled = true;
      document.getElementById('company').innerHTML = '<option value="">Chọn Công Ty</option>'; document.getElementById('company').disabled = true;
      document.getElementById('student').innerHTML = '<option value="">Chọn Họ và Tên</option>'; document.getElementById('student').disabled = true;
      if (cls && person) {
        const filtered = sheetData.filter(i => i['Lớp'] === cls && i['Phụ Trách'] === person);
        const unions = [...new Set(filtered.map(i => i['Nghiệp Đoàn']).filter(Boolean))].sort();
        unions.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u; opt.textContent = u;
          unionSelect.appendChild(opt);
        });
        unionSelect.disabled = false;
      }
      updateStartButton();
    }

    function onUnionChange() {
      const cls = document.getElementById('class').value;
      const person = document.getElementById('personInCharge').value;
      const union = document.getElementById('union').value;
      const companySelect = document.getElementById('company');
      companySelect.innerHTML = '<option value="">Chọn Công Ty</option>'; companySelect.disabled = true;
      document.getElementById('student').innerHTML = '<option value="">Chọn Họ và Tên</option>'; document.getElementById('student').disabled = true;
      if (cls && person && union) {
        const filtered = sheetData.filter(i => i['Lớp'] === cls && i['Phụ Trách'] === person && i['Nghiệp Đoàn'] === union);
        const companies = [...new Set(filtered.map(i => i['Công Ty']).filter(Boolean))].sort();
        companies.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c; opt.textContent = c;
          companySelect.appendChild(opt);
        });
        companySelect.disabled = false;
      }
      updateStartButton();
    }

    function onCompanyChange() {
      const cls = document.getElementById('class').value;
      const person = document.getElementById('personInCharge').value;
      const union = document.getElementById('union').value;
      const company = document.getElementById('company').value;
      const studentSelect = document.getElementById('student');
      studentSelect.innerHTML = '<option value="">Chọn Họ và Tên</option>'; studentSelect.disabled = true;
      if (cls && person && union && company) {
        const filteredStudents = sheetData.filter(i =>
          i['Lớp'] === cls &&
          i['Phụ Trách'] === person &&
          i['Nghiệp Đoàn'] === union &&
          i['Công Ty'] === company &&
          i['Họ Tên'] && i['Họ Tên'] !== 'Không rõ'
        );
        const sortedStudents = filteredStudents.sort((a, b) => a['Họ Tên'].localeCompare(b['Họ Tên']));
        sortedStudents.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s['Họ Tên'];
          opt.textContent = s['Họ Tên'];
          studentSelect.appendChild(opt);
        });
        studentSelect.disabled = sortedStudents.length === 0;
      }
      updateStartButton();
    }

    function updateStartButton() {
      const cls = document.getElementById('class').value;
      const person = document.getElementById('personInCharge').value;
      const union = document.getElementById('union').value;
      const company = document.getElementById('company').value;
      const studentVal = document.getElementById('student').value;
      const btn = document.getElementById('btnStart');
      const canStart = cls && person && union && company && studentVal;
      btn.disabled = !canStart;
      btn.classList.toggle('enabled', canStart);
    }

    function startChecking() {
      isChecking = true;
      const container = document.getElementById('studentContainer');
      container.style.display = 'block';
      document.getElementById('lessonFilter').style.display = 'block';
      renderStudents();
      document.getElementById('historyButton').style.display = 'none';
      document.getElementById('failButton').style.display = 'inline-block';
      hideFailList();
    }

    function getSelectedStudent() {
      const name = document.getElementById('student').value;
      return sheetData.find(s => s['Họ Tên'] === name) || null;
    }

    function getFilteredQuestions() {
      if (currentLesson === 'all') return questions;
      return questions.filter(q => q.lesson === parseInt(currentLesson));
    }

    // Lấy kết quả từ Firestore
    async function getSavedResults(student, cls) {
      const key = `${encodeURIComponent(student['Họ Tên'])}_${cls}`;
      try {
        const docRef = db.collection(COLLECTION_NAME).doc(key);
        const doc = await docRef.get();
        return doc.exists ? doc.data().results : {};
      } catch (error) {
        console.error("Lỗi lấy dữ liệu Firestore:", error);
        return {};
      }
    }

    // Lưu kết quả vào Firestore
    async function saveResult(student, cls, results) {
      const key = `${encodeURIComponent(student['Họ Tên'])}_${cls}`;
      try {
        await db.collection(COLLECTION_NAME).doc(key).set({
          name: student['Họ Tên'],
          class: cls,
          results: results,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      } catch (error) {
        console.error("Lỗi lưu Firestore:", error);
      }
    }

    // Xóa kết quả (nếu cần)
    async function deleteResult(student, cls) {
      const key = `${encodeURIComponent(student['Họ Tên'])}_${cls}`;
      try {
        await db.collection(COLLECTION_NAME).doc(key).delete();
      } catch (error) {
        console.error("Lỗi xóa:", error);
      }
    }

    async function renderStudents() {
      const container = document.getElementById('studentContainer');
      const student = getSelectedStudent();
      const filteredQuestions = getFilteredQuestions();
      if (!student) {
        container.innerHTML = '<div class="no-data">Vui lòng chọn học viên từ danh sách.</div>';
        return;
      }

      const saved = await getSavedResults(student, student['Lớp']);
      let html = `
        <div class="student-card">
          <div class="student-header">${student['Họ Tên']} - ${student['Lớp']}
            <span style="float:right;font-size:0.9em;">${student['Công Ty']} | ${student['Nghiệp Đoàn']}</span>
          </div>
          <div style="padding:15px;">
            <table class="question-table">
              <thead>
                <tr>
                  <th class="question-id">ID</th>
                  <th class="question-text">Nội dung câu hỏi</th>
                  <th class="check-col">Đạt</th>
                  <th class="check-col">Không Đạt</th>
                </tr>
              </thead>
              <tbody>
      `;

      filteredQuestions.forEach(q => {
        const qid = q.id;
        const status = saved[qid] || '';
        html += `
          <tr>
            <td class="question-id">${q.id}</td>
            <td class="question-text">${q.text}</td>
            <td class="check-col">
              <div class="check-circle ${status === 'pass' ? 'pass' : ''}"
                   onclick="toggleResult('${qid}', 'pass')"></div>
            </td>
            <td class="check-col">
              <div class="check-circle ${status === 'fail' ? 'fail' : ''}"
                   onclick="toggleResult('${qid}', 'fail')"></div>
            </td>
          </tr>
        `;
      });

      const checkedQuestions = filteredQuestions.filter(q => saved[q.id]);
      const passCount = checkedQuestions.filter(q => saved[q.id] === 'pass').length;
      const totalChecked = checkedQuestions.length;
      const percent = totalChecked > 0 ? (passCount / totalChecked * 100).toFixed(1) : '0.0';
      html += `
              </tbody>
            </table>
            <div class="summary">
              Đạt: <strong>${passCount}/${totalChecked}</strong> (${percent}%)
              ${totalChecked - passCount > 0 ? ` | <span class="fail-summary">Không đạt: ${totalChecked - passCount} câu</span>` : ''}
            </div>
          </div>
        </div>
      `;
      container.innerHTML = html;
    }

    window.toggleResult = async function(qid, value) {
      const student = getSelectedStudent();
      if (!student) return;

      const saved = await getSavedResults(student, student['Lớp']);
      if (saved[qid] === value) {
        delete saved[qid];
      } else {
        saved[qid] = value;
      }
      await saveResult(student, student['Lớp'], saved);
      renderStudents();
    };

    async function showFailedQuestions() {
      const failList = document.getElementById('failList');
      failList.innerHTML = '';
      const student = getSelectedStudent();
      if (!student) return;

      const saved = await getSavedResults(student, student['Lớp']);
      const filteredQuestions = getFilteredQuestions();
      const fails = filteredQuestions.filter(q => saved[q.id] === 'fail').map(q => q.id);

      if (fails.length > 0) {
        const div = document.createElement('div');
        div.className = 'fail-item';
        div.innerHTML = `<strong>${student['Họ Tên']} - ${student['Lớp']}</strong>:
          ${fails.map(id => `<span style="background:#ffeaa7;padding:2px 6px;border-radius:4px;margin:0 4px;">${id}</span>`).join('')}
        `;
        failList.appendChild(div);
        failList.style.display = 'block';
      } else {
        failList.innerHTML = '<em>Không có câu nào bị Không Đạt.</em>';
        failList.style.display = 'block';
      }
    }

    async function showHistory() {
      const failList = document.getElementById('failList');
      failList.innerHTML = '<div class="loading">Đang tải lịch sử từ Firestore...</div>';
      failList.style.display = 'block';

      try {
        const snapshot = await db.collection(COLLECTION_NAME).get();
        const groupedByClass = {};

        snapshot.forEach(doc => {
          const data = doc.data();
          const fails = Object.entries(data.results)
            .filter(([_, v]) => v === 'fail')
            .map(([k, _]) => k);
          if (fails.length === 0) return;

          if (!groupedByClass[data.class]) groupedByClass[data.class] = [];
          groupedByClass[data.class].push({ name: data.name, fails });
        });

        failList.innerHTML = '';
        const sortedClasses = Object.keys(groupedByClass).sort();
        if (sortedClasses.length === 0) {
          failList.innerHTML = '<em>Chưa có lịch sử kiểm tra.</em>';
          return;
        }

        sortedClasses.forEach(cls => {
          const classGroup = document.createElement('div');
          classGroup.className = 'fail-class-group';
          const classTitle = document.createElement('div');
          classTitle.className = 'fail-class-title';
          classTitle.textContent = `Lớp: ${cls}`;
          classGroup.appendChild(classTitle);

          const students = groupedByClass[cls];
          students.sort((a, b) => a.name.localeCompare(b.name));
          students.forEach(student => {
            const item = document.createElement('div');
            item.className = 'fail-item';
            item.innerHTML = `<strong>${student.name}</strong>:
              ${student.fails.map(id =>
                `<span style="background:#ffeaa7;padding:2px 6px;border-radius:4px;margin:0 4px;font-weight:bold;">${id}</span>`
              ).join('')}
            `;
            classGroup.appendChild(item);
          });
          failList.appendChild(classGroup);
        });
      } catch (error) {
        console.error("Lỗi tải lịch sử:", error);
        failList.innerHTML = '<em>Lỗi tải lịch sử từ Firestore.</em>';
      }
    }

    function hideFailList() {
      document.getElementById('failList').style.display = 'none';
    }

    window.onload = () => {
      fetchSheetData();
    };
  </script>
</body>
</html>
